<!doctype html>
<html>
	<head>
		<title>File Transfer</title>
		<meta charset="UTF-8">
		<meta name="description" content="Host a download link from your browser.">
		<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAJcEhZcwAAADwAAAA8AeouqI0AAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMjHxIGmVAAACu0lEQVQ4y62TX0hTcRTHrwhlBEHYc4yih5jLnKZppuIfms5qJstoiP8CfTFxpT2UaImhrkJDpmH5Z4I5dZr/nTrn3D83p6tsilAPYZhUL/bnwQf5dn6XuSSkpw58Luf3ved77rn3cDkAQkJAHCWO7ULg5SQhIk4Qx/9CxO1EymlhcF5KUnOH6sHya7Ox1eOwLXmctl/EFrFinxjRtlWXf7iRnNSWGiIM9hnj4gQBKeKgcqlYtCULF793W2Y2yIClOcsf7GYwzWWa/CKLCF1ltdJQUZlcKNzHSUOCHCSAicYB3ZrTMAabfgiLJgPMw30wj/TBbZ7GnH4YzqkxGId1n6j2p9czx9Flkx1uZ16zzg72wmWcxMLMJMxDOtipETPOUr5gYvoUn5fkZtq8DTZpAtEEO/S3Nb+1jvRjsEUNXVMd3LMGOA16zE/raZopXht4oYaFal61t7zjG5CXSxWLFKlhpz7bx4e2i3IU0Gs1oI+F9poKtFaXoeVhGZ8zTa/tQFG2giYb3r4YFrzBvJxcLvdX3VEqx3VaSOLOY7xLg66nKjTcVSIrPgpZiefQcO8WOuuqMdHTCUks1fRpUVtSXMy8/CaW5+2Jb6wz0NRWoF1VCaVcigJJLNIiQnjyk2N4TVNbiY4nlWC1tJUE3yrZga2pR/0YpQoZ8pKikU1Pzr8Qg3xJDLITInmt5PpldDc84lfqcVjjfQ1WXa4jHqf1a29TPQroabmJUchJiELxVRmUGZf4PIe0Amqme1bPGnxbcTgCud2x5LRFWUcHv5dmylFE4xZmpMG7KhRSo5vpKWD3LKODP5bnLGe5vWLFbheoqyrWr0Se8Zl3SI8OR2PV/XVWw/0r6HUCF0zTdaOdGk93s/pj7/PGtZGXGvei2VhDYx/e00R/lR/hTxwgDhKHvATsYr8XVufH/a/4DWsQDCB8J+4eAAAAAElFTkSuQmCC">
		<script type="text/javascript">
			var SocketRelay = {
				Client: function (host) {
					this.uploading = false;
					this.oncode = function (code) { };
					this.onstart = function () { };
					this.onfinish = function (status) { };
					this.ondisconnect = function () { };
					this.onprogress = function (eta, bps, progress) { };

					var chunkSize = 65536, chunk, lastChunk, uploaded = 0, lastUploaded = 0, size,
						timer, reader = new FileReader(), socket, wshost = host, self = this;

					this.cancel = function () {
						self.uploading = false;
						if (timer !== undefined) {
							clearInterval(timer);
							timer = undefined;
						}
						if (socket !== undefined && socket.readyState == 1) {
							socket.onclose = null;
							socket.close();
							self.onfinish("canceled");
						}
					};

					this.setFile = function (file, onerror) {
						if (onerror) {
							reader.onerror = onerror;
							reader.onloadend = function () {
								if (reader.error)
									onerror(reader.error);
								else
									self.setFile(file);
							};

							try {
								reader.readAsArrayBuffer(file.slice(0, 1));
							}
							catch (err) {
								onerror(err);
							}

							return;
						}

						self.cancel();
						socket = new WebSocket(wshost);
						socket.binaryType = "arraybuffer";

						timer = setInterval(function () {
							if (self.uploading) {
								var bps = uploaded - lastUploaded;
								self.onprogress((file.size - uploaded) / bps, bps, (uploaded / file.size) * 100);
								lastUploaded = uploaded;
							}
						}, 1000);

						socket.onopen = function () {
							socket.send(file.name);
							socket.send(file.size);
							socket.send(file.type);
						};

						reader.onloadend = function (e) {
							socket.send(e.target.result);
							uploaded += e.total;
						};

						socket.onmessage = function (e) {
							switch (e.data.slice(0, 4)) {
								case "code":
									self.oncode(e.data.substr(5));
									break;
								case "disc":
									self.uploading = false;
									self.ondisconnect();
									break;
								case "comp":
									socket.close(1000, "completed successfully");
									break;
								case "rang":
									var s = e.data.substr(7).split("-");
									uploaded = parseInt(s[0]);
									size = uploaded + parseInt(s[1]);
									chunk = Math.floor(uploaded / chunkSize) + 1;
									lastChunk = Math.floor(size / chunkSize) + 1;
									reader.readAsArrayBuffer(file.slice(uploaded, uploaded + (size > chunkSize ? chunkSize - (uploaded % chunkSize) : size)));
									self.onstart();
									self.uploading = true;
									break;
								default:
									reader.readAsArrayBuffer(file.slice(chunk++ * chunkSize, chunk * chunkSize - (chunk == lastChunk ? chunkSize - (size % chunkSize) : 0)));
									break;
							}
						};

						socket.onclose = function (e) {
							socket.onmessage = null;
							if (timer !== undefined) {
								clearInterval(timer);
								timer = undefined;
							}
							self.uploading = false;
							self.onfinish(e.reason);
						};
					};
				}
			};
		</script>
	</head>
	<body>
	<div style="position:fixed; width:100%; height:100%; top:10%">
		<div id="drop_zone" style="cursor:pointer; display:table; overflow:hidden; border-radius:50px; border-width:4px; border-style:dashed; border-color:lightgrey; margin:25px; margin-left:auto; margin-right:auto; width:75%; max-width:700px; height:175px">
			<div style="font-family:Consolas, Menlo, monospace; font-size:28px; text-align:center; display:table-cell; vertical-align:middle">
				<img id="file_icon" width="64" height="64" style="display:none; vertical-align:middle" src="data:image/png;base64,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"/>
				<span id="file_label">1. Select or drop file..</span>
			</div>
		</div>
		<div style="text-align:center; padding-top:25px">
			<div style="font-family:Consolas, Menlo, monospace; font-size:22px">
				<span id="download_url">2. receive single-use download link</span>
				<span id="copy_url" title="copy link to clipboard" style="cursor:pointer; display:none">&#x1F4CB</span>
				<span id="download_hint" style="font-size:14px; color:gray"><br>(transfer will begin when this link is visited, you must keep your browser open)</span>
			</div>
			<div id="progress_div" style="display:none; margin:10px">
				<span id="progress_label" style="font-family:Consolas, Menlo, monospace; font-size:16px; color:gray"></span>
				<br>
				<progress id="progress_bar" max="100" value="0" style="width:275px; height:32px"></progress>
				<img id="cancel_button" title="cancel transfer" width="28" height="28" style="cursor:pointer" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiNmMDAiLz48cmVjdCB0cmFuc2Zvcm09InJvdGF0ZSg0NSAzMiAzMikiIHg9IjI3IiB5PSIxMiIgd2lkdGg9IjEwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZmZmIi8+PHJlY3QgdHJhbnNmb3JtPSJyb3RhdGUoLTQ1IDMyIDMyKSIgeD0iMjciIHk9IjEyIiB3aWR0aD0iMTAiIGhlaWdodD0iNDAiIGZpbGw9IiNmZmYiLz48L3N2Zz4=" />
			</div>
		</div>
	</div>
	<input id="file_dialog" type="file" style="display:none" />
		<script type="text/javascript">
			(function () {
				var pacifier = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJ4TWlkWU1pZCIgY2xhc3M9Imxkcy1yaXBwbGUiPjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjAiIGZpbGw9Im5vbmUiIG5nLWF0dHItc3Ryb2tlPSI1IiBuZy1hdHRyLXN0cm9rZS13aWR0aD0iNSIgc3Ryb2tlPSIjMWQzZjcyIiBzdHJva2Utd2lkdGg9IjUiPjxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9InIiIGNhbGNNb2RlPSJzcGxpbmUiIHZhbHVlcz0iMDs0NSIga2V5VGltZXM9IjA7MSIgZHVyPSIxIiBrZXlTcGxpbmVzPSIwIDAuMiAwLjggMSIgYmVnaW49Ii0wLjVzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSI+PC9hbmltYXRlPjxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9Im9wYWNpdHkiIGNhbGNNb2RlPSJzcGxpbmUiIHZhbHVlcz0iMTswIiBrZXlUaW1lcz0iMDsxIiBkdXI9IjEiIGtleVNwbGluZXM9IjAuMiAwIDAuOCAxIiBiZWdpbj0iLTAuNXMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIj48L2FuaW1hdGU+PC9jaXJjbGU+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMCIgZmlsbD0ibm9uZSIgbmctYXR0ci1zdHJva2U9IjUiIG5nLWF0dHItc3Ryb2tlLXdpZHRoPSI1IiBzdHJva2U9IiM1Njk5ZDIiIHN0cm9rZS13aWR0aD0iNSI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgY2FsY01vZGU9InNwbGluZSIgdmFsdWVzPSIwOzQ1IiBrZXlUaW1lcz0iMDsxIiBkdXI9IjEiIGtleVNwbGluZXM9IjAgMC4yIDAuOCAxIiBiZWdpbj0iMHMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIj48L2FuaW1hdGU+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0ib3BhY2l0eSIgY2FsY01vZGU9InNwbGluZSIgdmFsdWVzPSIxOzAiIGtleVRpbWVzPSIwOzEiIGR1cj0iMSIga2V5U3BsaW5lcz0iMC4yIDAgMC44IDEiIGJlZ2luPSIwcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiPjwvYW5pbWF0ZT48L2NpcmNsZT48L3N2Zz4=";

				var formatBytes = function (bytes) {
					var suffix = ["Bytes", "KB", "MB", "GB", "TB"];
					var i = Math.floor(Math.log(bytes) / Math.log(1024));
					return (bytes > 0 ? bytes / Math.pow(1024, i) : 0).toFixed(i > 2 ? 1 : 0) + "&nbsp;" + suffix[i];
				};

				var transferFile = function (file, transfer) {
					if (file !== undefined && file !== null) {
						if (!transfer.uploading || confirm("Cancel current transfer?")) {
							if (typeof InstallTrigger !== "undefined") file_icon.src = "moz-icon://" + file.name.substr(file.name.lastIndexOf('.')) + "?size=32";
							file_icon.style.display = "inline";
							file_label.innerHTML = file.name + " (" + formatBytes(file.size) + ")";
							drop_zone.style["border-style"] = "solid";
							download_url.innerHTML = "<img width='32' height='32' src='" + pacifier + "' style='vertical-align:middle; margin:4px'>retrieving single-use url...";
							download_url.style.color = "black";
							transfer.setFile(file, function (e) { download_url.innerHTML = "could not load file (" + e.name + ")"; download_url.style.color = "red"; })
						}
					}
				};

				var transfer = new SocketRelay.Client(new String(window.location).replace(/^http/, "ws"));

				transfer.oncode = function (code) {
					var link = (window.location.hostname.split(".").length != 2) ? new String(window.location).replace(/\/$/, "") + "/" + code : new String(window.location).replace(window.location.hostname, code + "." + window.location.hostname).replace(/\/$/, "");
					download_url.style.color = "black";
					download_url.innerHTML = link;
					download_hint.style.display = "inline";
					copy_url.style.display = "inline";
				};

				transfer.onstart = function () {
					download_url.innerHTML = "uploading...";
					download_url.style.color = "green";
					download_hint.style.display = "none";
					copy_url.style.display = "none";
				};

				transfer.ondisconnect = function () {
					download_url.innerHTML = "downloader disconnected, waiting to resume..";
					download_url.style.color = "gray";
				};

				transfer.onfinish = function (status) {
					download_url.innerHTML = status == "" ? "unknown failure" : status;
					download_url.style.color = status.indexOf("success") > -1 ? "green" : "red";
					progress_div.style.display = "none";
					copy_url.style.display = "none";
				};

				transfer.onprogress = function (eta, bps, progress) {
					progress_bar.value = progress;
					progress_label.innerHTML = (bps <= 0) ? "--:--:-- (0&nbsp;Bytes/sec)" : new Date(0, 0, 0, 0, 0, eta).toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/, "$1") + " (" + formatBytes(bps) + "/sec)";
					progress_div.style.display = "block";
				};

				file_dialog.onchange = function () { transferFile(this.files[0], transfer); };
				drop_zone.onclick = function () { file_dialog.click(); };
				drop_zone.ondragover = function () { this.style['border-color'] = 'cornflowerblue'; file_label.style.color = 'cornflowerblue'; };
				drop_zone.ondragleave = function () { this.style['border-color'] = 'lightgrey'; file_label.style.color = 'black'; };
				drop_zone.ondrop = function (e) { this.ondragleave(); transferFile(e.dataTransfer.files[0], transfer); };
				cancel_button.onclick = function () { transfer.cancel(); };
				window.ondragover = function (e) { e.preventDefault(); };
				window.ondrop = function (e) { e.preventDefault(); };
				window.onbeforeunload = function () { if (transfer.uploading) return "Cancel current transfer?"; };

				copy_url.onmousedown = function () { download_url.style.color = "lightgrey"; };
				copy_url.onmouseup = function () { download_url.style.color = "black"; };
				copy_url.ontouchstart = copy_url.onmousedown;
				copy_url.ontouchend = copy_url.onmouseup;
				copy_url.onclick = function () {
					var selection = window.getSelection();
					var range = document.createRange();
					range.selectNodeContents(download_url);
					selection.removeAllRanges();
					selection.addRange(range);
					document.execCommand("Copy");
					selection.removeAllRanges();
				};

			})();
		</script>
	</body>
</html>